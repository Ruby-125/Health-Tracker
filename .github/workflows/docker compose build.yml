name: Docker CI/CD

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

env:
  DOCKER_REGISTRY: docker.io
  IMAGE_NAME: health-tracker

jobs:
  # Job 1: Build and Test
  build-and-test:
    name: Build & Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Verify Docker Compose File
        run: |
          if [ ! -f docker-compose.yml ]; then
            echo "‚ùå docker-compose.yml not found!"
            exit 1
          fi
          echo "‚úÖ docker-compose.yml found"

      - name: Build Docker Images
        run: |
          docker compose build
          echo "‚úÖ Docker Compose build completed"

      - name: Run Tests
        run: |
          echo "üß™ Running tests..."
          # Add your test commands here:
          # docker compose run backend npm test
          echo "‚úÖ Tests passed"

  # Job 2: Push to Docker Hub
  push-to-dockerhub:
    name: Push to Docker Hub
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build & Push Backend Image
        uses: docker/build-push-action@v4
        with:
          context: ./backend
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}-backend:latest
            ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}-backend:${{ github.sha }}

      - name: Build & Push Frontend Image
        uses: docker/build-push-action@v4
        with:
          context: ./frontend
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}-frontend:latest
            ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}-frontend:${{ github.sha }}

      - name: Success Notification
        run: |
          echo "üéâ Docker images pushed successfully!"
          echo "Backend: ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}-backend:latest"
          echo "Frontend: ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}-frontend:latest"
